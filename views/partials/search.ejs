<section class="search">
    <div class="search-container">
        <div class="search-input-wrapper">
            <input type="text" placeholder="ğŸ”æ¤œç´¢...">
            <button class="clear-btn" id="clear">Ã—</button>
        </div>
        <button id="cancel" class="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    <div class="search-list"></div>
</section>
<script>
/* æ¤œç´¢å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‚ç…§ã‚’å–å¾— */
const searchSection = document.querySelector('.search');
const searchInput = searchSection.querySelector('input[type="text"]');

/* --- ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¤œç´¢ãƒœã‚¿ãƒ³ã®å‡¦ç†å®šç¾© --- */
/* ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¤œç´¢ãƒœã‚¿ãƒ³ã¨é€£æºã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ */
const searchButton = document.querySelector('.search-button');
/* ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¤œç´¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç† */
searchButton.addEventListener('click', () => {
    if(searchSection) searchSection.classList.add("active");
    const query = searchInput.value.trim();
});

/* --- æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ãƒœã‚¿ãƒ³å‡¦ç†å®šç¾© --- */
/* ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç† */
const cancelButton = document.getElementById('cancel');
cancelButton.addEventListener('click', () => {
    if(searchSection) searchSection.classList.remove("active");
});

/* ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç† */
const clearButton = document.getElementById('clear');
clearButton.addEventListener('click', () => {
    searchInput.value = '';
    const searchList = searchSection.querySelector('.search-list');
    if(searchList) searchList.innerHTML = '';
    if(searchSection) searchSection.style.height = '135px';
});

/* æ¤œç´¢å…¥åŠ›å‡¦ç† */
searchInput.addEventListener('input', () => {

    // ã‚µãƒ¼ãƒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å…¨è¡¨ç¤º
    if(searchSection) searchSection.style.height = '100%';

    const searchList = searchSection.querySelector('.search-list');
    const text = searchInput.value.trim().toLowerCase();

    // åˆæœŸåŒ–
    searchList.innerHTML = '';

    // ç©ºæ–‡å­—ãªã‚‰ä½•ã‚‚è¡¨ç¤ºã—ãªã„
    if (!text) return;

    let hitCount = 0;

    // SCHEDULES ã‚’å…¨èµ°æŸ»
    Object.entries(SCHEDULES).forEach(([id, schedule]) => {

        if (schedule.title.toLowerCase().includes(text)) {

            hitCount++; // ãƒ’ãƒƒãƒˆä»¶æ•°

            /* --- ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆé–‹å§‹ --- */
            const item = document.createElement('div');
            item.classList.add('search-item');
            // æ—¥ä»˜ã¯ start_date ã‹ã‚‰å–å¾—
            const date = schedule.start_date?.split('T')[0] ?? '';
            // æ—¥ä»˜ã®è¨­å®š
            const dateEl = createElementDate(date);
            // ã‚¿ã‚¤ãƒˆãƒ«ã®è¨­å®š
            const titleEl = createElemenTitle(schedule);
            // æ—¥ä»˜ â†’ ã‚¿ã‚¤ãƒˆãƒ«ã®é †ã«è¡¨ç¤º
            item.appendChild(dateEl);
            item.appendChild(titleEl);
            createAddEvent(schedule,item);
            /* --- ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆçµ‚äº† --- */

            searchList.appendChild(item);
        }
    });

    // ãƒ’ãƒƒãƒˆãªã—
    if (hitCount === 0) {
        searchList.innerHTML = `<div class="search-empty">è©²å½“ã™ã‚‹äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    }
});

/*
 * ------------------------------------------------------------------
 * æ—¥ä»˜è¦ç´ ã®ä½œæˆ
 * @param {number} date  yyyy-mm-dd
 * 
 * @return divè¦ç´ 
 * ------------------------------------------------------------------
 */
function createElementDate(date) {
    const dateEl = document.createElement('div');
    dateEl.classList.add('search-item-date');
    dateEl.textContent = date;
    return dateEl;
}
/*
 * ------------------------------------------------------------------
 * ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ ã®ä½œæˆ
 * @param {Object} schedule  
 * 
 * @return divè¦ç´ 
 * ------------------------------------------------------------------
 */
function createElemenTitle(schedule) {
    const titleEl = document.createElement('div');
    titleEl.classList.add('search-item-title');
    titleEl.textContent = schedule.title
    titleEl.style.borderLeft = `6px solid ${schedule.label_color}`;
    return titleEl;
}

/*
 * ------------------------------------------------------------------
 * ãƒ‡ãƒ¼ã‚¿ä¿æŒè¦ç´ ã®ä½œæˆ
 * @param {Object} schedule  
 * @param {element} item
 * 
 * @return input[hidden]è¦ç´ 
 * ------------------------------------------------------------------
 */
function createAddEvent(schedule,element){
    element.addEventListener('click', ()=>{
            const startDate = new Date(schedule.start_date);
            const year = startDate.getFullYear();
            const month = startDate.getMonth() + 1;
            const day = startDate.getDate();
            location.href = `/updEvent?year=${year}&month=${month}&day=${day}&id=${schedule.id}`;
    });
}
</script>